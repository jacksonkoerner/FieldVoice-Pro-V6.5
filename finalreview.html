<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Final Review - DOT RPR Daily Report</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png">
    <meta name="theme-color" content="#4a7c59">

    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FieldVoice">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 11px;
            line-height: 1.3;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            color: #000;
        }

        /* Page container */
        .page {
            width: 8.5in;
            min-height: 11in;
            margin: 0 auto;
            background: white;
            padding: 0.4in;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Header area */
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #4a7c59;
        }
        .header-logo {
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-logo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .header-logo-placeholder {
            width: 100px;
            height: 100px;
            border: 2px solid #4a7c59;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 8px;
            font-weight: bold;
            color: #4a7c59;
            padding: 8px;
        }
        .header-title {
            text-align: right;
        }
        .header-title h1 {
            font-size: 28px;
            font-weight: bold;
            color: #4a7c59;
            margin: 0;
            letter-spacing: 1px;
        }

        /* Section headers */
        .section-header {
            background: #4a7c59;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            padding: 6px 10px;
            font-size: 11px;
            letter-spacing: 0.5px;
            margin: 0;
        }
        .section-header.red {
            background: #b91c1c;
        }
        .section-header.blue {
            background: #1e40af;
        }
        .section-header.purple {
            background: #6b21a8;
        }
        .section-header.amber {
            background: #d97706;
        }
        .section-header.navy {
            background: #1e3a5f;
        }

        /* Form table styles */
        .form-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
        }
        .form-table td,
        .form-table th {
            border: 1px solid #000;
            padding: 4px 6px;
            vertical-align: middle;
        }
        .form-table .label {
            background: #e5e5e5;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 9px;
            width: 18%;
            white-space: nowrap;
        }
        .form-table .value {
            background: white;
            width: 32%;
            font-size: 10px;
        }
        .form-table .weather-label {
            background: #e5e5e5;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 9px;
            vertical-align: top;
            width: 12%;
        }
        .form-table .weather-data {
            background: white;
            font-size: 10px;
            line-height: 1.5;
        }
        .form-table .signature-area {
            background: white;
            vertical-align: bottom;
            text-align: center;
        }
        .signature-line {
            border-bottom: 1px solid #000;
            padding-bottom: 2px;
            margin-bottom: 2px;
            min-height: 20px;
        }
        .signature-name {
            font-style: italic;
            font-size: 10px;
        }
        .signature-note {
            font-size: 8px;
            color: #666;
        }

        /* Daily Work Summary styles */
        .work-summary-intro {
            font-weight: bold;
            font-size: 10px;
            margin: 8px 0;
            text-decoration: underline;
        }
        .contractor-block {
            margin-bottom: 12px;
            page-break-inside: avoid;
        }
        .contractor-header {
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 4px;
        }
        .contractor-narrative {
            margin-bottom: 4px;
            font-size: 10px;
            text-align: justify;
        }
        .contractor-details {
            font-size: 10px;
        }
        .contractor-details strong {
            font-weight: bold;
        }

        /* Data table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
            font-size: 10px;
        }
        .data-table th {
            background: #e5e5e5;
            border: 1px solid #000;
            padding: 4px 6px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 9px;
            text-align: center;
        }
        .data-table td {
            border: 1px solid #000;
            padding: 4px 6px;
            vertical-align: top;
        }
        .data-table .totals-row {
            background: #f0f0f0;
            font-weight: bold;
        }
        .data-table .text-center {
            text-align: center;
        }

        /* Text section styles */
        .text-section {
            border: 1px solid #000;
            margin-bottom: 12px;
        }
        .text-section-content {
            padding: 8px;
            min-height: 40px;
            font-size: 10px;
        }

        /* Safety checkbox styles */
        .safety-checkbox {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-right: 16px;
        }
        .checkbox-box {
            width: 14px;
            height: 14px;
            border: 1px solid #000;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10px;
        }

        /* Photo styles */
        .photo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .photo-item {
            border: 1px solid #000;
            page-break-inside: avoid;
        }
        .photo-item-header {
            background: #e5e5e5;
            padding: 4px 8px;
            font-weight: bold;
            font-size: 9px;
            text-transform: uppercase;
            border-bottom: 1px solid #000;
        }
        .photo-item-image {
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 150px;
        }
        .photo-item-image img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
        }
        .photo-item-caption {
            padding: 6px 8px;
            font-size: 9px;
            border-top: 1px solid #000;
            background: white;
        }
        .photo-meta {
            color: #666;
            margin-bottom: 4px;
        }

        /* Signature block at end */
        .signature-block {
            margin-top: 20px;
            border: 1px solid #000;
        }
        .signature-block-content {
            padding: 12px;
        }
        .signature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 16px;
        }
        .signature-field label {
            font-size: 9px;
            font-weight: bold;
            text-transform: uppercase;
            color: #666;
            display: block;
            margin-bottom: 2px;
        }
        .signature-field span {
            font-size: 11px;
        }
        .final-signature {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            margin-top: 16px;
        }
        .final-signature-line {
            flex: 1;
        }
        .final-signature-line .line {
            border-bottom: 1px solid #000;
            height: 30px;
        }
        .final-signature-line .label {
            font-size: 9px;
            color: #666;
            margin-top: 2px;
        }
        .final-signature-date {
            width: 120px;
        }
        .final-signature-date .line {
            border-bottom: 1px solid #000;
            height: 30px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 2px;
            font-size: 10px;
        }
        .final-signature-date .label {
            font-size: 9px;
            color: #666;
            margin-top: 2px;
            text-align: center;
        }

        /* Toolbar - no print */
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #1e3a5f;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .toolbar-btn {
            background: #334155;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }
        .toolbar-btn:hover {
            background: #475569;
        }
        .toolbar-btn.primary {
            background: #4a7c59;
        }
        .toolbar-btn.primary:hover {
            background: #3d6b4a;
        }
        .toolbar-btn.danger {
            background: #b91c1c;
        }
        .toolbar-btn.danger:hover {
            background: #991b1b;
        }
        .toolbar-title {
            font-size: 14px;
            font-weight: bold;
        }
        .toolbar-date {
            font-size: 11px;
            color: #94a3b8;
        }

        /* Page content with toolbar offset */
        .page-wrapper {
            padding-top: 60px;
            padding-bottom: 20px;
        }

        /* Page break */
        .page-break {
            page-break-before: always;
        }

        /* Print styles */
        @media print {
            body {
                background: white;
            }
            .no-print {
                display: none !important;
            }
            .page-wrapper {
                padding-top: 0;
            }
            .page {
                width: 100%;
                margin: 0;
                padding: 0.3in;
                box-shadow: none;
            }
            .section-header {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .form-table .label,
            .form-table .weather-label,
            .data-table th,
            .data-table .totals-row,
            .photo-item-header {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .photo-item {
                page-break-inside: avoid;
            }
            .contractor-block {
                page-break-inside: avoid;
            }
            @page {
                size: 8.5in 11in;
                margin: 0.25in;
            }
        }

        /* Mobile responsive */
        @media screen and (max-width: 900px) {
            .page {
                width: 100%;
                padding: 12px;
            }
            .header-logo,
            .header-logo-placeholder {
                width: 70px;
                height: 70px;
            }
            .header-title h1 {
                font-size: 18px;
            }
            .form-table .label,
            .form-table .value {
                width: auto;
            }
            .photo-grid {
                grid-template-columns: 1fr;
            }
            .signature-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- TOOLBAR (no-print) -->
    <div class="toolbar no-print">
        <div class="toolbar-left">
            <a id="editReportLink" href="#" class="toolbar-btn">
                <i class="fas fa-edit"></i>
                <span>Edit Report</span>
            </a>
            <div>
                <div class="toolbar-title">DOT RPR Daily Report</div>
                <div id="headerDate" class="toolbar-date"></div>
            </div>
        </div>
        <div style="display: flex; gap: 8px;">
            <button onclick="exportPDF()" class="toolbar-btn primary">
                <i class="fas fa-file-pdf"></i>
                <span>Export PDF</span>
            </button>
            <button onclick="showCancelModal()" class="toolbar-btn danger">
                <i class="fas fa-times"></i>
                <span>Cancel</span>
            </button>
            <a href="index.html" class="toolbar-btn">
                <i class="fas fa-home"></i>
            </a>
        </div>
    </div>

    <!-- PAGE WRAPPER -->
    <div class="page-wrapper">
        <!-- PAGE 1 -->
        <div class="page" id="page1">
            <!-- HEADER -->
            <div class="report-header">
                <div class="header-logo" id="logoContainer">
                    <div class="header-logo-placeholder" id="logoPlaceholder">
                        LOUIS ARMSTRONG<br>NEW ORLEANS<br>INTERNATIONAL<br>AIRPORT
                    </div>
                </div>
                <div class="header-title">
                    <h1>RPR DAILY REPORT</h1>
                </div>
            </div>

            <!-- PROJECT OVERVIEW SECTION -->
            <div class="section-header">PROJECT OVERVIEW</div>
            <table class="form-table">
                <tbody>
                    <tr>
                        <td class="label">Project Name:</td>
                        <td class="value" id="displayProjectName">--</td>
                        <td class="label">Date:</td>
                        <td class="value" id="displayDate">--</td>
                    </tr>
                    <tr>
                        <td class="label">NOAB Project No.:</td>
                        <td class="value" id="displayNoabProjectNo">--</td>
                        <td class="label">Location:</td>
                        <td class="value" id="displayLocation">--</td>
                    </tr>
                    <tr>
                        <td class="label">CNO Solicitation No.:</td>
                        <td class="value" id="displayCnoSolicitationNo">N/A</td>
                        <td class="label">Engineer:</td>
                        <td class="value" id="displayEngineer">--</td>
                    </tr>
                    <tr>
                        <td class="label">Notice to Proceed:</td>
                        <td class="value" id="displayNoticeToProceed">--</td>
                        <td class="label">Contractor:</td>
                        <td class="value" id="displayContractor">--</td>
                    </tr>
                    <tr>
                        <td class="label">Contract Duration:</td>
                        <td class="value" id="displayContractDuration">--</td>
                        <td class="label">Start Time:</td>
                        <td class="value" id="displayStartTime">--</td>
                    </tr>
                    <tr>
                        <td class="label">Expected Completion:</td>
                        <td class="value" id="displayExpectedCompletion">--</td>
                        <td class="label">End Time:</td>
                        <td class="value" id="displayEndTime">--</td>
                    </tr>
                    <tr>
                        <td class="label">Contract Day #:</td>
                        <td class="value" id="displayContractDay">--</td>
                        <td class="label">Shift Duration:</td>
                        <td class="value" id="displayShiftDuration">--</td>
                    </tr>
                    <tr>
                        <td class="label">Weather Days:</td>
                        <td class="value" id="displayWeatherDays">0</td>
                        <td class="label">Completed By:</td>
                        <td class="value" id="displayCompletedBy">--</td>
                    </tr>
                    <!-- Weather Block -->
                    <tr>
                        <td class="weather-label" rowspan="5">Weather:</td>
                        <td class="weather-data" colspan="1">
                            <span id="displayWeatherTemps">High Temp: --  Low Temp: --</span>
                        </td>
                        <td class="label" rowspan="5">Signature:</td>
                        <td class="signature-area" rowspan="5">
                            <div class="signature-line" id="displaySignatureInline"></div>
                            <div class="signature-name" id="displaySignatureNameInline">--</div>
                            <div class="signature-note">Digitally signed</div>
                        </td>
                    </tr>
                    <tr>
                        <td class="weather-data">
                            Precipitation: <span id="displayWeatherPrecip">0.00"</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="weather-data">
                            General Condition: <span id="displayWeatherCondition">--</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="weather-data">
                            Job Site Condition: <span id="displayWeatherJobSite">--</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="weather-data">
                            Adverse Conditions: <span id="displayWeatherAdverse">N/A</span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- DAILY WORK SUMMARY SECTION -->
            <div class="section-header">DAILY WORK SUMMARY</div>
            <div style="border: 1px solid #000; border-top: none; padding: 8px; margin-bottom: 12px;">
                <div class="work-summary-intro">Construction Activities Performed and Observed on this Date:</div>
                <div id="workSummaryContainer">
                    <!-- Contractor blocks will be populated here -->
                </div>
            </div>

            <!-- DAILY OPERATIONS TABLE -->
            <div class="section-header">DAILY OPERATIONS</div>
            <table class="data-table" id="personnelTable">
                <thead>
                    <tr>
                        <th style="min-width: 80px;">Contractor</th>
                        <th style="min-width: 60px;">Trade</th>
                        <th style="width: 50px;">Super(s)</th>
                        <th style="width: 50px;">Foreman</th>
                        <th style="width: 55px;">Operator(s)</th>
                        <th style="width: 55px;">Laborer(s)</th>
                        <th style="width: 55px;">Surveyor(s)</th>
                        <th style="width: 50px;">Other(s)</th>
                        <th style="width: 50px;">Total</th>
                    </tr>
                </thead>
                <tbody id="personnelTableBody">
                    <!-- Rows will be populated here -->
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td colspan="2" style="text-align: right; padding-right: 8px;">TOTALS:</td>
                        <td class="text-center" id="totalSuper">0</td>
                        <td class="text-center" id="totalForeman">0</td>
                        <td class="text-center" id="totalOperators">0</td>
                        <td class="text-center" id="totalLaborers">0</td>
                        <td class="text-center" id="totalSurveyors">0</td>
                        <td class="text-center" id="totalOthers">0</td>
                        <td class="text-center" id="totalAll">0</td>
                    </tr>
                </tfoot>
            </table>

            <!-- MOBILIZED EQUIPMENT & DAILY UTILIZATION -->
            <div class="section-header">MOBILIZED EQUIPMENT &amp; DAILY UTILIZATION</div>
            <table class="data-table" id="equipmentTable">
                <thead>
                    <tr>
                        <th style="width: 20%;">Contractor</th>
                        <th style="width: 45%;">Equipment Type / Model</th>
                        <th style="width: 10%;">Qty</th>
                        <th style="width: 25%;">Notes (Status)</th>
                    </tr>
                </thead>
                <tbody id="equipmentTableBody">
                    <!-- Rows will be populated here -->
                </tbody>
            </table>

            <!-- GENERAL ISSUES SECTION -->
            <div class="text-section">
                <div class="section-header red">GENERAL ISSUES; UNFORESEEN CONDITIONS; NOTICES GIVEN</div>
                <div class="text-section-content" id="issuesContent">N/A</div>
            </div>

            <!-- COMMUNICATIONS SECTION -->
            <div class="text-section">
                <div class="section-header blue">COMMUNICATIONS WITH THE CONTRACTOR</div>
                <div class="text-section-content" id="communicationsContent">N/A</div>
            </div>

            <!-- QA/QC SECTION -->
            <div class="text-section">
                <div class="section-header purple">QA/QC TESTING AND/OR INSPECTIONS</div>
                <div class="text-section-content" id="qaqcContent">N/A</div>
            </div>

            <!-- SAFETY REPORT SECTION -->
            <div class="text-section">
                <div class="section-header">SAFETY REPORT</div>
                <div class="text-section-content">
                    <div style="margin-bottom: 8px;">
                        <strong>Safety Incident Today:</strong>
                        <span class="safety-checkbox">
                            <span class="checkbox-box" id="incidentYes"></span> Yes
                        </span>
                        <span class="safety-checkbox">
                            <span class="checkbox-box" id="incidentNo">X</span> No
                        </span>
                    </div>
                    <div id="safetyContent">N/A</div>
                </div>
            </div>

            <!-- VISITORS/DELIVERIES SECTION -->
            <div class="text-section">
                <div class="section-header amber">VISITORS; DELIVERIES; ADDITIONAL CONTRACT AND/OR CHANGE ORDER ACTIVITIES; OTHER REMARKS</div>
                <div class="text-section-content" id="visitorsContent">N/A</div>
            </div>
        </div>

        <!-- PAGE 2+ - PHOTOS -->
        <div class="page page-break" id="photosPage">
            <div class="section-header navy">DAILY PHOTOS <span id="photoCount" style="float: right; font-weight: normal;">(0 photos)</span></div>
            <div id="photosContainer" style="border: 1px solid #000; border-top: none; padding: 12px;">
                <!-- Photos will be populated here -->
            </div>
        </div>

        <!-- SIGNATURE PAGE -->
        <div class="page page-break" id="signaturePage">
            <div class="signature-block">
                <div class="section-header navy">CERTIFICATION &amp; SIGNATURE</div>
                <div class="signature-block-content">
                    <p style="font-size: 10px; margin-bottom: 16px;">
                        I certify that the information contained in this daily report is accurate and complete to the best of my knowledge.
                    </p>
                    <div class="signature-grid">
                        <div class="signature-field">
                            <label>Inspector Name</label>
                            <span id="displaySignatureName">--</span>
                        </div>
                        <div class="signature-field">
                            <label>Title</label>
                            <span id="displaySignatureTitle">--</span>
                        </div>
                        <div class="signature-field">
                            <label>Company</label>
                            <span id="displaySignatureCompany">--</span>
                        </div>
                    </div>
                    <div class="final-signature">
                        <div class="final-signature-line">
                            <div class="line"></div>
                            <div class="label">Signature</div>
                        </div>
                        <div class="final-signature-date">
                            <div class="line" id="displaySignatureDate"></div>
                            <div class="label">Date</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Confirmation Modal -->
    <div id="cancelModal" class="no-print" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; width: 100%; max-width: 400px;">
            <div style="background: #b91c1c; color: white; padding: 16px; text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 8px;"></i>
                <p style="font-weight: bold; text-transform: uppercase; margin: 0;">Cancel Ongoing Report</p>
            </div>
            <div style="padding: 16px;">
                <p style="font-size: 12px; color: #666; margin-bottom: 12px;">
                    Are you sure you want to cancel this report? This will <strong>permanently delete</strong> all data for this report date.
                </p>
                <p id="cancelReportDate" style="font-weight: bold; color: #b91c1c; margin-bottom: 16px;"></p>
                <button onclick="confirmCancel()" style="width: 100%; padding: 12px; background: #b91c1c; color: white; border: none; font-weight: bold; text-transform: uppercase; cursor: pointer; margin-bottom: 8px;">
                    <i class="fas fa-trash-alt" style="margin-right: 8px;"></i>Delete Report
                </button>
                <button onclick="hideCancelModal()" style="width: 100%; padding: 12px; background: #f1f5f9; color: #666; border: none; font-weight: 500; cursor: pointer;">
                    Keep Report
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="no-print" style="position: fixed; bottom: 16px; right: 16px; z-index: 9999;"></div>

    <script>
        // ============ STATE ============
        let report = null;
        let activeProject = null;
        let projectContractors = [];
        let reportDate = '';

        const PROJECTS_KEY = 'fvp_projects';
        const ACTIVE_PROJECT_KEY = 'fvp_active_project';

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            // Get date from URL param
            const params = new URLSearchParams(window.location.search);
            reportDate = params.get('date') || new Date().toISOString().split('T')[0];

            // Load project
            loadActiveProject();

            // Load report data
            report = loadReport();

            if (!report || !report.overview) {
                showToast('Report not found', 'error');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            // Update edit report link
            document.getElementById('editReportLink').href = `report.html?date=${reportDate}`;

            // Populate all display fields
            populateAllFields();

            // Update header date
            updateHeaderDate();
        });

        // ============ PROJECT LOADING ============
        function loadActiveProject() {
            const activeId = localStorage.getItem(ACTIVE_PROJECT_KEY);
            if (!activeId) {
                activeProject = null;
                projectContractors = [];
                return;
            }

            const projectsJson = localStorage.getItem(PROJECTS_KEY);
            if (!projectsJson) {
                activeProject = null;
                projectContractors = [];
                return;
            }

            try {
                const projects = JSON.parse(projectsJson);
                activeProject = projects.find(p => p.id === activeId) || null;
                if (activeProject && activeProject.contractors) {
                    projectContractors = [...activeProject.contractors].sort((a, b) => {
                        if (a.type === 'prime' && b.type !== 'prime') return -1;
                        if (a.type !== 'prime' && b.type === 'prime') return 1;
                        return 0;
                    });
                } else {
                    projectContractors = [];
                }
            } catch (e) {
                console.error('Failed to load project:', e);
                activeProject = null;
                projectContractors = [];
            }
        }

        // ============ REPORT LOADING ============
        function getReportKey() {
            if (activeProject) {
                return `fieldvoice_report_${activeProject.id}_${reportDate}`;
            }
            return `fieldvoice_report_${reportDate}`;
        }

        function loadReport() {
            // Try project-specific key first
            let key = getReportKey();
            let saved = localStorage.getItem(key);

            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {}
            }

            // Try legacy key
            const legacyKey = `fieldvoice_report_${reportDate}`;
            saved = localStorage.getItem(legacyKey);
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {}
            }

            // Try very old legacy key
            saved = localStorage.getItem('fieldvoice_report');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {}
            }

            return null;
        }

        // ============ DATA PRIORITY HELPERS ============
        function getValue(path, defaultValue = '') {
            // Check user edits first
            if (report.userEdits && report.userEdits[path] !== undefined) {
                return report.userEdits[path];
            }

            // Check AI-generated content
            if (report.aiGenerated) {
                const aiValue = getNestedValue(report.aiGenerated, path);
                if (aiValue !== undefined && aiValue !== null && aiValue !== '') {
                    if (Array.isArray(aiValue)) {
                        return aiValue.join('\n');
                    }
                    return aiValue;
                }
            }

            // Check existing report data
            const reportValue = getNestedValue(report, path);
            if (reportValue !== undefined && reportValue !== null && reportValue !== '') {
                if (Array.isArray(reportValue)) {
                    return reportValue.join('\n');
                }
                return reportValue;
            }

            return defaultValue;
        }

        function getNestedValue(obj, path) {
            return path.split('.').reduce((o, k) => (o || {})[k], obj);
        }

        function getTextFieldValue(reportPath, aiPath, defaultValue = '') {
            // Check user edits
            if (report.userEdits && report.userEdits[reportPath] !== undefined) {
                return report.userEdits[reportPath];
            }

            // Check AI-generated
            if (report.aiGenerated) {
                const aiValue = getNestedValue(report.aiGenerated, aiPath);
                if (aiValue !== undefined && aiValue !== null && aiValue !== '') {
                    if (Array.isArray(aiValue)) {
                        return aiValue.join('\n');
                    }
                    return aiValue;
                }
            }

            // Check report
            const reportValue = getNestedValue(report, reportPath);
            if (reportValue !== undefined && reportValue !== null && reportValue !== '') {
                if (Array.isArray(reportValue)) {
                    return reportValue.join('\n');
                }
                return reportValue;
            }

            return defaultValue;
        }

        // ============ POPULATE FIELDS ============
        function populateAllFields() {
            // Project Logo
            const logoContainer = document.getElementById('logoContainer');
            const logoPlaceholder = document.getElementById('logoPlaceholder');
            if (activeProject?.logo) {
                logoContainer.innerHTML = `<img src="${activeProject.logo}" alt="Project Logo">`;
            }

            // Report Date
            const dateObj = new Date(reportDate + 'T12:00:00');
            const formattedDate = dateObj.toLocaleDateString('en-US', {
                month: '2-digit',
                day: '2-digit',
                year: 'numeric'
            });
            const longFormattedDate = dateObj.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Project Overview - Left Column
            document.getElementById('displayProjectName').textContent = getValue('overview.projectName', activeProject?.name || '--');
            document.getElementById('displayNoabProjectNo').textContent = getValue('overview.noabProjectNo', activeProject?.noabProjectNo || '--');
            document.getElementById('displayCnoSolicitationNo').textContent = getValue('overview.cnoSolicitationNo', 'N/A');

            if (activeProject?.noticeToProceed) {
                document.getElementById('displayNoticeToProceed').textContent = formatDateDisplay(activeProject.noticeToProceed);
            }
            if (activeProject?.contractDuration) {
                document.getElementById('displayContractDuration').textContent = activeProject.contractDuration + ' days';
            }
            if (activeProject?.expectedCompletion) {
                document.getElementById('displayExpectedCompletion').textContent = formatDateDisplay(activeProject.expectedCompletion);
            }

            const contractDay = getValue('overview.contractDay', '');
            if (contractDay && activeProject?.contractDuration) {
                document.getElementById('displayContractDay').textContent = `Day ${contractDay} of ${activeProject.contractDuration}`;
            } else if (contractDay) {
                document.getElementById('displayContractDay').textContent = contractDay;
            }

            document.getElementById('displayWeatherDays').textContent = getValue('overview.weatherDays', activeProject?.weatherDays || '0') + ' days';

            // Project Overview - Right Column
            document.getElementById('displayDate').textContent = formattedDate;
            document.getElementById('displayLocation').textContent = getValue('overview.location', activeProject?.location || '--');
            document.getElementById('displayEngineer').textContent = getValue('overview.engineer', activeProject?.engineer || '--');
            document.getElementById('displayContractor').textContent = getValue('overview.contractor', activeProject?.primeContractor || '--');

            const startTime = getValue('overview.startTime', '');
            const endTime = getValue('overview.endTime', '');
            document.getElementById('displayStartTime').textContent = formatTimeDisplay(startTime);
            document.getElementById('displayEndTime').textContent = formatTimeDisplay(endTime);
            document.getElementById('displayShiftDuration').textContent = calculateShiftDuration(startTime, endTime);

            document.getElementById('displayCompletedBy').textContent = getValue('overview.completedBy', '--');

            // Weather - combined format
            const highTemp = getValue('overview.weather.highTemp', '--');
            const lowTemp = getValue('overview.weather.lowTemp', '--');
            document.getElementById('displayWeatherTemps').textContent = `High Temp: ${highTemp}  Low Temp: ${lowTemp}`;
            document.getElementById('displayWeatherPrecip').textContent = getValue('overview.weather.precipitation', '0.00"');
            document.getElementById('displayWeatherCondition').textContent = getValue('overview.weather.generalCondition', '--');
            document.getElementById('displayWeatherJobSite').textContent = getValue('overview.weather.jobSiteCondition', '--');
            document.getElementById('displayWeatherAdverse').textContent = getValue('overview.weather.adverseConditions', 'N/A') || 'N/A';

            // Inline signature in overview
            const signatureName = getValue('signature.name', getValue('overview.completedBy', '--'));
            document.getElementById('displaySignatureNameInline').textContent = signatureName;

            // Text Sections
            const issues = getTextFieldValue('issues', 'generalIssues', report.guidedNotes?.issues || '');
            document.getElementById('issuesContent').innerHTML = formatTextContent(issues);

            const communications = getTextFieldValue('communications', 'contractorCommunications', '');
            document.getElementById('communicationsContent').innerHTML = formatTextContent(communications);

            const qaqc = getTextFieldValue('qaqc', 'qaqcNotes', '');
            document.getElementById('qaqcContent').innerHTML = formatTextContent(qaqc);

            const safetyNotes = getTextFieldValue('safety.notes', 'safety.notes', report.guidedNotes?.safety || '');
            document.getElementById('safetyContent').innerHTML = formatTextContent(safetyNotes);

            // Safety Incident Checkboxes
            const hasIncident = getValue('safety.hasIncident', false);
            if (hasIncident) {
                document.getElementById('incidentYes').textContent = 'X';
                document.getElementById('incidentNo').textContent = '';
            } else {
                document.getElementById('incidentYes').textContent = '';
                document.getElementById('incidentNo').textContent = 'X';
            }

            const visitors = getTextFieldValue('visitors', 'visitorsRemarks', '');
            document.getElementById('visitorsContent').innerHTML = formatTextContent(visitors);

            // Final Signature Block
            document.getElementById('displaySignatureName').textContent = getValue('signature.name', '--');
            document.getElementById('displaySignatureTitle').textContent = getValue('signature.title', '--');
            document.getElementById('displaySignatureCompany').textContent = getValue('signature.company', '--');
            document.getElementById('displaySignatureDate').textContent = formattedDate;

            // Render dynamic sections
            renderWorkSummary();
            renderPersonnelTable();
            renderEquipmentTable();
            renderPhotos();
        }

        // ============ FORMAT HELPERS ============
        function formatDateDisplay(isoDate) {
            if (!isoDate) return '--';
            const date = new Date(isoDate + 'T12:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatTimeDisplay(time24) {
            if (!time24) return '--';
            const [hours, minutes] = time24.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes} ${ampm}`;
        }

        function calculateShiftDuration(startTime, endTime) {
            if (!startTime || !endTime) return '--';
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            let diffMs = end - start;
            if (diffMs < 0) diffMs += 24 * 60 * 60 * 1000;
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            if (minutes > 0) return `${hours}h ${minutes}m`;
            return `${hours} hours`;
        }

        function formatTextContent(text) {
            if (!text || text.trim() === '') return 'N/A';
            // Check if it looks like bullet points
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length > 1 && lines.every(l => l.trim().startsWith('-') || l.trim().startsWith('*') || l.trim().startsWith('•'))) {
                const listItems = lines.map(l => `<li>${escapeHtml(l.replace(/^[-*•]\s*/, ''))}</li>`).join('');
                return `<ul style="margin: 0; padding-left: 20px;">${listItems}</ul>`;
            }
            return escapeHtml(text).replace(/\n/g, '<br>');
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ============ RENDER WORK SUMMARY ============
        function renderWorkSummary() {
            const container = document.getElementById('workSummaryContainer');

            if (projectContractors.length === 0) {
                const workSummary = getValue('guidedNotes.workSummary', '');
                if (workSummary) {
                    container.innerHTML = `<div class="contractor-narrative">${escapeHtml(workSummary)}</div>`;
                } else {
                    container.innerHTML = `<p style="color: #666; font-style: italic;">No work activities documented.</p>`;
                }
                return;
            }

            let html = '';
            projectContractors.forEach(contractor => {
                const activity = getContractorActivity(contractor.id);
                const noWork = activity?.noWork ?? true;
                const narrative = activity?.narrative || '';
                const equipment = activity?.equipmentUsed || '';
                const crew = activity?.crew || '';

                const typeLabel = contractor.type === 'prime' ? 'Prime' : 'Sub';
                const tradesDisplay = contractor.trades ? ` (${contractor.trades})` : '';

                html += `
                    <div class="contractor-block">
                        <div class="contractor-header">${escapeHtml(contractor.name)} - ${typeLabel}${tradesDisplay}</div>
                        ${noWork && !narrative ?
                            `<div class="contractor-narrative" style="font-style: italic;">No work performed on ${formatDateDisplay(reportDate)}.</div>` :
                            `<div class="contractor-narrative">${escapeHtml(narrative) || 'N/A'}</div>
                            ${equipment ? `<div class="contractor-details"><strong>EQUIPMENT:</strong> ${escapeHtml(equipment)}</div>` : ''}
                            ${crew ? `<div class="contractor-details"><strong>CREW:</strong> ${escapeHtml(crew)}</div>` : ''}`
                        }
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getContractorActivity(contractorId) {
            const userEditKey = `activity_${contractorId}`;
            if (report.userEdits && report.userEdits[userEditKey]) {
                return report.userEdits[userEditKey];
            }

            if (report.aiGenerated?.activities) {
                const aiActivity = report.aiGenerated.activities.find(a => a.contractorId === contractorId);
                if (aiActivity) {
                    return {
                        contractorId: contractorId,
                        noWork: aiActivity.noWork ?? false,
                        narrative: aiActivity.narrative || '',
                        equipmentUsed: aiActivity.equipmentUsed || '',
                        crew: aiActivity.crew || ''
                    };
                }
            }

            if (report.activities) {
                return report.activities.find(a => a.contractorId === contractorId);
            }
            return null;
        }

        // ============ RENDER PERSONNEL TABLE ============
        function renderPersonnelTable() {
            const tbody = document.getElementById('personnelTableBody');

            if (projectContractors.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: #666; padding: 12px;">
                            No contractors defined.
                        </td>
                    </tr>
                `;
                return;
            }

            let totals = { super: 0, foreman: 0, operators: 0, laborers: 0, surveyors: 0, others: 0, all: 0 };

            const rows = projectContractors.map(contractor => {
                const ops = getContractorOperations(contractor.id);
                const supers = ops?.superintendents || 0;
                const foremen = ops?.foremen || 0;
                const operators = ops?.operators || 0;
                const laborers = ops?.laborers || 0;
                const surveyors = ops?.surveyors || 0;
                const others = ops?.others || 0;
                const rowTotal = supers + foremen + operators + laborers + surveyors + others;

                totals.super += supers;
                totals.foreman += foremen;
                totals.operators += operators;
                totals.laborers += laborers;
                totals.surveyors += surveyors;
                totals.others += others;
                totals.all += rowTotal;

                return `
                    <tr>
                        <td style="font-weight: 500;">${escapeHtml(contractor.abbreviation || contractor.name)}</td>
                        <td>${escapeHtml(contractor.trades || '-')}</td>
                        <td class="text-center">${supers || '-'}</td>
                        <td class="text-center">${foremen || '-'}</td>
                        <td class="text-center">${operators || '-'}</td>
                        <td class="text-center">${laborers || '-'}</td>
                        <td class="text-center">${surveyors || '-'}</td>
                        <td class="text-center">${others || '-'}</td>
                        <td class="text-center" style="font-weight: bold;">${rowTotal || '-'}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;

            // Update totals
            document.getElementById('totalSuper').textContent = totals.super || '-';
            document.getElementById('totalForeman').textContent = totals.foreman || '-';
            document.getElementById('totalOperators').textContent = totals.operators || '-';
            document.getElementById('totalLaborers').textContent = totals.laborers || '-';
            document.getElementById('totalSurveyors').textContent = totals.surveyors || '-';
            document.getElementById('totalOthers').textContent = totals.others || '-';
            document.getElementById('totalAll').textContent = totals.all || '-';
        }

        function getContractorOperations(contractorId) {
            const userEditKey = `operations_${contractorId}`;
            if (report.userEdits && report.userEdits[userEditKey]) {
                return report.userEdits[userEditKey];
            }

            if (report.aiGenerated?.operations) {
                const aiOps = report.aiGenerated.operations.find(o => o.contractorId === contractorId);
                if (aiOps) return aiOps;
            }

            if (report.operations) {
                return report.operations.find(o => o.contractorId === contractorId);
            }
            return null;
        }

        // ============ RENDER EQUIPMENT TABLE ============
        function renderEquipmentTable() {
            const tbody = document.getElementById('equipmentTableBody');
            const equipmentData = getEquipmentData();

            if (equipmentData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666; padding: 12px;">
                            No equipment documented.
                        </td>
                    </tr>
                `;
                return;
            }

            const rows = equipmentData.map(item => {
                const contractor = projectContractors.find(c => c.id === item.contractorId);
                const contractorName = contractor ? (contractor.abbreviation || contractor.name) : '--';
                const status = item.status === 'IDLE' ? 'IDLE' : item.status || 'IDLE';

                return `
                    <tr>
                        <td>${escapeHtml(contractorName)}</td>
                        <td>${escapeHtml(item.type || '--')}</td>
                        <td class="text-center">${item.qty || 1}</td>
                        <td style="${status === 'IDLE' ? 'color: #666; font-style: italic;' : 'color: #4a7c59; font-weight: 500;'}">${status}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function getEquipmentData() {
            if (report.equipment && report.equipment.length > 0) {
                return report.equipment;
            }

            if (report.aiGenerated?.equipment && report.aiGenerated.equipment.length > 0) {
                return report.aiGenerated.equipment.map(item => ({
                    contractorId: item.contractorId || '',
                    type: item.type || '',
                    qty: item.qty || item.quantity || 1,
                    status: item.status || (item.hoursUsed ? `${item.hoursUsed} hrs` : 'IDLE')
                }));
            }

            return [];
        }

        // ============ RENDER PHOTOS ============
        function renderPhotos() {
            const container = document.getElementById('photosContainer');
            const photos = report.photos || [];
            const totalPhotos = photos.length;

            document.getElementById('photoCount').textContent = `(${totalPhotos} photo${totalPhotos !== 1 ? 's' : ''})`;

            if (totalPhotos === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <i class="fas fa-images" style="font-size: 32px; margin-bottom: 8px;"></i>
                        <p style="margin: 0;">No photos captured</p>
                    </div>
                `;
                // Hide photos page if no photos
                document.getElementById('photosPage').style.display = 'none';
                return;
            }

            let html = '<div class="photo-grid">';
            photos.forEach((photo, index) => {
                const photoNum = index + 1;
                const dateStr = photo.date || '--';
                const timeStr = photo.time || '--';
                const gpsStr = photo.gps
                    ? `${photo.gps.lat.toFixed(5)}, ${photo.gps.lng.toFixed(5)}`
                    : null;

                html += `
                    <div class="photo-item">
                        <div class="photo-item-header">Photo ${photoNum} of ${totalPhotos}</div>
                        <div class="photo-item-image">
                            <img src="${photo.url}" alt="Progress photo ${photoNum}" onerror="this.parentNode.innerHTML='<div style=\\'padding: 20px; text-align: center; color: #999;\\'><i class=\\'fas fa-exclamation-triangle\\' style=\\'font-size: 24px;\\'></i><br>Failed to load</div>'">
                        </div>
                        <div class="photo-item-caption">
                            <div class="photo-meta">
                                <i class="fas fa-calendar-alt"></i> ${dateStr} &nbsp;
                                <i class="fas fa-clock"></i> ${timeStr}
                                ${gpsStr ? `&nbsp; <i class="fas fa-map-marker-alt"></i> ${gpsStr}` : ''}
                            </div>
                            ${photo.caption ? escapeHtml(photo.caption) : '<span style="color: #999; font-style: italic;">No caption</span>'}
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // ============ UI HELPERS ============
        function updateHeaderDate() {
            const dateObj = new Date(reportDate + 'T12:00:00');
            const dateStr = dateObj.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            document.getElementById('headerDate').textContent = dateStr;
        }

        // ============ CANCEL MODAL ============
        function showCancelModal() {
            const dateObj = new Date(reportDate + 'T12:00:00');
            const formattedDate = dateObj.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            document.getElementById('cancelReportDate').textContent = formattedDate;
            document.getElementById('cancelModal').style.display = 'flex';
        }

        function hideCancelModal() {
            document.getElementById('cancelModal').style.display = 'none';
        }

        function confirmCancel() {
            const key = getReportKey();
            localStorage.removeItem(key);

            const legacyKey = `fieldvoice_report_${reportDate}`;
            localStorage.removeItem(legacyKey);

            const legacyReport = localStorage.getItem('fieldvoice_report');
            if (legacyReport) {
                try {
                    const parsed = JSON.parse(legacyReport);
                    const legacyDate = parsed.overview?.date;
                    if (legacyDate) {
                        const d = new Date(legacyDate);
                        if (d.toISOString().split('T')[0] === reportDate) {
                            localStorage.removeItem('fieldvoice_report');
                        }
                    }
                } catch (e) {}
            }

            showToast('Report deleted', 'success');
            hideCancelModal();
            setTimeout(() => window.location.href = 'index.html', 1500);
        }

        // ============ EXPORT PDF ============
        function exportPDF() {
            window.print();
        }

        // ============ TOAST ============
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                success: '#4a7c59',
                error: '#b91c1c',
                warning: '#d97706',
                info: '#1e40af'
            };
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            toast.style.cssText = `background: ${colors[type]}; color: white; padding: 12px 16px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px; margin-bottom: 8px; transform: translateX(120%); transition: transform 0.3s ease;`;
            toast.innerHTML = `<i class="fas ${icons[type]}"></i><span style="font-weight: bold; font-size: 12px;">${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => toast.style.transform = 'translateX(0)', 10);
            setTimeout(() => {
                toast.style.transform = 'translateX(120%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>

    <!-- PWA Navigation Fix -->
    <script>
        (function() {
            if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
                document.addEventListener('click', function(e) {
                    const link = e.target.closest('a');
                    if (link && link.href && link.href.startsWith(window.location.origin)) {
                        e.preventDefault();
                        window.location.href = link.href;
                    }
                }, true);
            }
        })();
    </script>

    <!-- PWA Service Worker Registration & Offline Banner -->
    <div id="offline-banner" class="no-print" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: #f59e0b; color: #78350f; text-align: center; padding: 8px 16px; font-weight: bold; font-size: 12px; z-index: 9999; transform: translateY(-100%); transition: transform 0.3s ease;">
        <i class="fas fa-wifi-slash" style="margin-right: 8px;"></i>You are offline - Some features may be unavailable
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('[PWA] Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.error('[PWA] Service Worker registration failed:', error);
                    });
            });
        }

        const offlineBanner = document.getElementById('offline-banner');
        function showOfflineBanner() {
            if (offlineBanner) {
                offlineBanner.style.display = 'block';
                setTimeout(() => offlineBanner.style.transform = 'translateY(0)', 10);
            }
        }
        function hideOfflineBanner() {
            if (offlineBanner) {
                offlineBanner.style.transform = 'translateY(-100%)';
                setTimeout(() => offlineBanner.style.display = 'none', 300);
            }
        }
        window.addEventListener('online', hideOfflineBanner);
        window.addEventListener('offline', showOfflineBanner);
        if (!navigator.onLine) showOfflineBanner();
    </script>
</body>
</html>
